<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History | WAB Cargo</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { 
            /* Same Premium Background as Admin & Login */
            background: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('https://images.unsplash.com/photo-1553413077-190dd305871c?auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            font-family: 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* CONTAINER WITH GLASS EFFECT */
        .glass-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            overflow: hidden;
            margin-top: 30px;
        }

        /* HEADER SECTION */
        .page-header {
            background: #111;
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #333;
        }
        .brand-text { font-weight: 800; font-size: 1.5rem; letter-spacing: 1px; }

        /* STATS WIDGETS */
        .stats-row { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 5px solid #333;
            transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-icon { font-size: 2rem; opacity: 0.2; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #666; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: #111; line-height: 1; }

        /* TABLE DESIGN */
        .table-responsive { padding: 0; }
        .table { margin-bottom: 0; }
        .table th { 
            background: #222; 
            color: #ccc; 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 0.5px;
            padding: 15px 20px;
            border: none;
        }
        .table td { 
            padding: 15px 20px; 
            vertical-align: middle; 
            font-size: 0.9rem; 
            border-bottom: 1px solid #eee; 
            background: white;
        }
        .table tr:hover td { background: #f0f4f8; }

        /* BADGES */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }
        .badge-delivered { background: #d4edda; color: #155724; }
        .badge-active { background: #cce5ff; color: #004085; }
        .badge-hold { background: #fff3cd; color: #856404; }

        /* PRINT SETTINGS (Keep white paper look for printing) */
        @media print {
            body { background: white; padding: 0; }
            .glass-container { box-shadow: none; border: 1px solid #000; margin: 0; border-radius: 0; }
            .no-print { display: none !important; }
            .page-header { background: white; color: black; border-bottom: 2px solid black; }
            .stat-card { border: 1px solid #ccc; box-shadow: none; }
            .table th { background: #eee; color: black; }
        }
    </style>
</head>
<body>

    <div class="container mt-4 mb-2 no-print d-flex justify-content-between">
        <a href="admins.html" class="btn btn-outline-light btn-sm fw-bold">
            <i class="fas fa-arrow-left me-2"></i> BACK TO DASHBOARD
        </a>
        <button onclick="window.print()" class="btn btn-light btn-sm fw-bold shadow">
            <i class="fas fa-print me-2"></i> PRINT REPORT
        </button>
    </div>

    <div class="container">
        <div class="glass-container">
            
            <div class="page-header">
                <div>
                    <div class="brand-text"><i class="fas fa-shipping-fast me-2"></i> WAB CARGO</div>
                    <div class="small opacity-50">Transaction History Ledger</div>
                </div>
                <div class="text-end">
                    <div class="h5 m-0 fw-bold" id="reportDate">...</div>
                    <small class="opacity-50 text-uppercase">Generated Report</small>
                </div>
            </div>

            <div class="stats-row">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="stat-card" style="border-left-color: #333;">
                            <div>
                                <div class="stat-label">Total Shipments</div>
                                <div class="stat-value" id="totalCount">0</div>
                            </div>
                            <i class="fas fa-cubes stat-icon text-dark"></i>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="border-left-color: #0d6efd;">
                            <div>
                                <div class="stat-label">Active / In Transit</div>
                                <div class="stat-value text-primary" id="activeCount">0</div>
                            </div>
                            <i class="fas fa-plane-departure stat-icon text-primary"></i>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="border-left-color: #198754;">
                            <div>
                                <div class="stat-label">Delivered Successfully</div>
                                <div class="stat-value text-success" id="deliveredCount">0</div>
                            </div>
                            <i class="fas fa-check-circle stat-icon text-success"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Created Date</th>
                            <th>Waybill No.</th>
                            <th>Sender</th>
                            <th>Receiver</th>
                            <th>Destination</th>
                            <th class="text-end">Status</th>
                        </tr>
                    </thead>
                    <tbody id="txTable">
                        <tr><td colspan="6" class="text-center p-5 text-muted">Accessing Database...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="p-3 bg-light border-top text-center text-muted small">
                &copy; WAB CARGO AND LOGISTICS SERVICES â€¢ Official Transaction Record
            </div>

        </div>
    </div>

    <script>
    // 1. SAFE CONFIGURATION
    const SUPABASE_URL = 'https://pfgyfljvysxqsvuiehez.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmZ3lmbGp2eXN4cXN2dWllaGV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTcyNTMsImV4cCI6MjA4Mzk5MzI1M30.hIt_dGYpiQuKt_LJAfIZlBtnpY6HTt2Dn8xq1gRAXJU';

    // FIX: Check if the client already exists to prevent the crash
    if (typeof window.sbClient === 'undefined') {
        window.sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
    // Use 'sb' for all database calls
    var sb = window.sbClient;

    // Set Report Date
    document.getElementById('reportDate').innerText = new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // 2. AUTH CHECK
    async function checkSession() {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) window.location.href = "login.html";
    }
    checkSession();

    // 3. FETCH TRANSACTIONS
    async function fetchTransactions() {
        const tbody = document.getElementById('txTable');
        
        try {
            // Loading State
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-5 text-muted"><i class="fas fa-spinner fa-spin"></i> Loading Ledger...</td></tr>';

            // Fetch Data using 'sb'
            const { data, error } = await sb
                .from('shipments')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            if(data) {
                // Update Stats Cards
                const total = data.length;
                const delivered = data.filter(i => i.status === 'Delivered').length;
                const active = total - delivered;

                document.getElementById('totalCount').innerText = total;
                document.getElementById('deliveredCount').innerText = delivered;
                document.getElementById('activeCount').innerText = active;

                // Populate Table
                tbody.innerHTML = '';
                
                if (total === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-5 text-muted">No transactions found.</td></tr>';
                    return;
                }

                data.forEach(item => {
                    const dateObj = new Date(item.created_at);
                    const dateStr = dateObj.toLocaleDateString();
                    
                    // Badge Styling Logic
                    let badgeClass = 'badge-active';
                    let icon = '<i class="fas fa-sync fa-spin small me-1"></i>';
                    
                    if(item.status === 'Delivered') { 
                        badgeClass = 'badge-delivered'; 
                        icon = '<i class="fas fa-check small me-1"></i>';
                    }
                    if(item.status === 'On Hold' || item.status === 'Customs') {
                        badgeClass = 'badge-hold';
                        icon = '<i class="fas fa-clock small me-1"></i>';
                    }

                    // Render Row
                    tbody.innerHTML += `
                        <tr>
                            <td class="text-secondary fw-bold" style="font-family: monospace;">${dateStr}</td>
                            <td><span class="text-dark fw-bold">${item.tracking_number}</span></td>
                            <td>${item.sender_name || '<span class="text-muted">-</span>'}</td>
                            <td>${item.receiver_name || '<span class="text-muted">-</span>'}</td>
                            <td><i class="fas fa-map-marker-alt text-muted me-1"></i> ${item.destination}</td>
                            <td class="text-end">
                                <span class="status-badge ${badgeClass}">${icon} ${item.status}</span>
                            </td>
                        </tr>
                    `;
                });
            }
        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="6" class="text-center p-5 text-danger">Error loading data: ${err.message}</td></tr>`;
        }
    }

    // Run
    fetchTransactions();
</script>

</body>
</html>
