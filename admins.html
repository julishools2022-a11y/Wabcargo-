<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAB Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --brand-black: #000000; --brand-gray: #1a1a1a; }
        
        body { 
            background: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('https://images.unsplash.com/photo-1553413077-190dd305871c?auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            font-family: 'Segoe UI', Roboto, sans-serif; 
            min-height: 100vh;
            padding-top: 70px; /* Space for fixed navbar */
            overflow-x: hidden;
        }

        /* GLASS COMPONENTS */
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
        }

        .card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4) !important;
        }

        /* Nav Link Styling */
        .nav-link {
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            margin: 0 5px;
            border-radius: 5px;
        }
        .nav-link:hover { color: #000; background: rgba(0,0,0,0.05); }
        .nav-link.active {
            color: #000 !important;
            font-weight: 700;
            background: rgba(0,0,0,0.1);
        }

        /* Full Screen Tweaks */
        .container-fluid { max-width: 100%; }
        
        @media(max-width: 768px) {
            .container-fluid { padding-left: 0; padding-right: 0; }
            .content-wrapper { padding: 15px; }
            .card { border-radius: 0; border-left: 0; border-right: 0; }
        }

        @media(min-width: 769px) {
            .content-wrapper { padding: 25px 40px; }
        }

        .hover-stop:hover { animation-play-state: paused; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container-fluid px-3 px-lg-5">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <div class="bg-dark text-white rounded p-1 me-2 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                <i class="fas fa-boxes-stacked"></i>
            </div>
            <div style="line-height: 1;">
                <span class="d-block fw-bold" style="letter-spacing: -1px; font-family: 'Arial Black', sans-serif;">WAB<span style="color:#666;">CARGO</span></span>
                <small class="text-muted" style="font-size: 9px; letter-spacing: 2px;">LOGISTICS ADMIN</small>
            </div>
        </a>

        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <i class="fas fa-bars"></i>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" href="index.html">
                        <i class="fas fa-list me-1"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="create-shipment.html">
                        <i class="fas fa-plus-circle me-1"></i> Create Shipment
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="transactions.html">
                        <i class="fas fa-file-invoice-dollar me-1"></i> Transactions
                    </a>
                </li>
            </ul>

            <div class="d-flex align-items-center border-start ps-lg-3 ms-lg-3 mt-3 mt-lg-0">
                <div class="me-3 text-end d-none d-lg-block" style="line-height: 1.2;">
                    <small class="d-block fw-bold">Administrator</small>
                    <small class="d-block text-success" style="font-size: 10px;">● Online</small>
                </div>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm fw-bold w-100 w-lg-auto">
                    <i class="fas fa-power-off"></i> <span class="d-lg-none">Log Out</span>
                </button>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid content-wrapper">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="ps-2 ps-lg-0">
            <h4 class="fw-bold text-white m-0">Operations Overview</h4>
            <small class="text-white-50">Manage your active shipments</small>
        </div>
        <button class="btn btn-light btn-sm fw-bold shadow me-2 me-lg-0" onclick="fetchAllShipments()">
            <i class="fas fa-sync fa-spin hover-stop text-dark"></i> <span class="d-none d-sm-inline">REFRESH DATA</span>
        </button>
    </div>

    <div class="card border-0 shadow-sm w-100">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 w-100">
                <thead class="table-light small text-muted text-uppercase">
                    <tr>
                        <th class="ps-4 py-3">Shipment Information</th>
                        <th class="text-end pe-4">Controls</th>
                    </tr>
                </thead>
                <tbody id="shipmentTable">
                    </tbody>
            </table>
        </div>
    </div>

</div>

<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold">Update Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="editId">
                <input type="hidden" id="editTrackingNum"> 
                <label class="fw-bold mb-2 small text-muted">NEW LOCATION</label>
                <input type="text" id="editLocation" class="form-control mb-3" placeholder="e.g. Arrived at London Heathrow">
                <label class="fw-bold mb-2 small text-muted">NEW STATUS</label>
                <select id="editStatus" class="form-select mb-4 fw-bold">
                    <option value="Picked Up">Picked Up</option>
                    <option value="In Transit">In Transit</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Customs">Customs Clearance</option>
                    <option value="Delivered">Delivered</option>
                </select>
                <button onclick="saveUpdate()" class="btn btn-dark w-100 py-2 fw-bold">CONFIRM UPDATE</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-history me-2"></i> Timeline Check</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="p-3 bg-light border-bottom">
                    <strong class="text-uppercase text-muted small">Tracking Number:</strong>
                    <span id="historyTrk" class="fw-bold ms-2 text-dark">...</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead class="small text-muted">
                            <tr>
                                <th class="ps-4">Date/Time</th>
                                <th>Status</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
                <div class="p-3 text-end bg-light border-top">
                    <a href="#" id="fullHistoryLink" target="_blank" class="btn btn-sm btn-dark">View Full Audit Report</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
 // 1. SAFE CONFIGURATION
const SUPABASE_URL = 'https://pfgyfljvysxqsvuiehez.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmZ3lmbGp2eXN4cXN2dWllaGV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTcyNTMsImV4cCI6MjA4Mzk5MzI1M30.hIt_dGYpiQuKt_LJAfIZlBtnpY6HTt2Dn8xq1gRAXJU';

// IMPORTANT: Use 'var' and a check to prevent the "Already Declared" crash
if (typeof supabaseAdmin === 'undefined') {
    var supabaseAdmin = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}

// 2. AUTH CHECK
async function checkSession() {
    try {
        const { data: { session } } = await supabaseAdmin.auth.getSession();
        if (!session) {
            window.location.href = "login.html";
        } else {
            // Only fetch data if we are logged in
            fetchAllShipments();
        }
    } catch (e) {
        console.error("Auth initialization failed:", e);
    }
}

// 3. LOGOUT
async function logout() { 
    await supabaseAdmin.auth.signOut(); 
    window.location.href = "login.html"; 
}

// 4. FETCH DATA
async function fetchAllShipments() {
    const tbody = document.getElementById('shipmentTable');
    tbody.innerHTML = '<tr><td colspan="2" class="text-center p-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading shipments...</td></tr>';

    const { data, error } = await supabaseAdmin
        .from('shipments')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        alert("Error fetching data: " + error.message);
        return;
    }
    
    tbody.innerHTML = ''; 

    if(data && data.length > 0) {
        data.forEach(item => {
            let badgeClass = 'bg-secondary';
            if(item.status === 'Delivered') badgeClass = 'bg-success';
            if(item.status === 'On Hold') badgeClass = 'bg-warning text-dark';
            if(item.status === 'In Transit') badgeClass = 'bg-primary';

            tbody.innerHTML += `
                <tr>
                    <td class="ps-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded p-2 me-3 text-center border" style="width:50px; height:50px; display:grid; place-items:center;">
                                <i class="fas fa-box fa-lg text-muted"></i>
                            </div>
                            <div>
                                <span class="fw-bold text-dark">${item.tracking_number}</span>
                                <div class="small text-muted mt-1">
                                    <i class="fas fa-user-circle me-1"></i> ${item.sender_name || 'Sender'} &rarr; ${item.receiver_name || 'Receiver'}
                                </div>
                                <div class="mt-2">
                                    <span class="badge ${badgeClass} fw-normal px-2 py-1 shadow-sm">${item.status}</span>
                                    <small class="text-muted ms-2"><i class="fas fa-map-marker-alt me-1"></i> ${item.current_location}</small>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="text-end pe-4 align-middle">
                        <div class="btn-group shadow-sm">
                            <button class="btn btn-sm btn-white border fw-bold" onclick="openUpdateModal(${item.id}, '${item.tracking_number}')">EDIT</button>
                            <button class="btn btn-sm btn-light border" onclick="viewHistory('${item.tracking_number}')"><i class="fas fa-history"></i></button>
                            <a href="waybill.html?track=${item.tracking_number}" target="_blank" class="btn btn-sm btn-dark"><i class="fas fa-print"></i></a>
                        </div>
                    </td>
                </tr>
            `;
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="2" class="text-center p-5 text-muted">No shipments found.</td></tr>';
    }
}

// 5. VIEW HISTORY
async function viewHistory(trackingNum) {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '<tr><td colspan="3" class="text-center p-3">Loading history...</td></tr>';
    document.getElementById('historyTrk').innerText = trackingNum;
    
    new bootstrap.Modal(document.getElementById('historyModal')).show();

    const { data, error } = await supabaseAdmin
        .from('shipment_events')
        .select('*')
        .eq('tracking_number', trackingNum)
        .order('timestamp', { ascending: false });

    if(error) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-danger p-3">Error loading history</td></tr>';
    } else {
        tbody.innerHTML = '';
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center p-3">No history events found.</td></tr>';
        }
        data.forEach(event => {
            const dateStr = new Date(event.timestamp || event.created_at).toLocaleString();
            tbody.innerHTML += `
                <tr>
                    <td class="ps-4 text-muted small">${dateStr}</td>
                    <td class="fw-bold">${event.status}</td>
                    <td>${event.location}</td>
                </tr>
            `;
        });
    }
}

// Initialize
checkSession();


    // 5. UPDATE STATUS
    function openUpdateModal(id, trackingNum) {
        document.getElementById('editId').value = id;
        document.getElementById('editTrackingNum').value = trackingNum; 
        new bootstrap.Modal(document.getElementById('updateModal')).show();
    }

    async function saveUpdate() {
    const id = document.getElementById('editId').value;
    const trackingNum = document.getElementById('editTrackingNum').value;
    const newLoc = document.getElementById('editLocation').value;
    const newStat = document.getElementById('editStatus').value;

    if(!newLoc) return alert("Please enter a location");

    try {
        // 1. Update the main shipment record
        // Use 'supabaseAdmin' instead of 'supabase'
        const { error: shipError } = await supabaseAdmin
            .from('shipments')
            .update({ current_location: newLoc, status: newStat })
            .eq('id', id);

        if (shipError) throw shipError;

        // 2. Insert the new event into history
        const { error: eventError } = await supabaseAdmin
            .from('shipment_events')
            .insert([{ 
                tracking_number: trackingNum, 
                location: newLoc, 
                status: newStat,
                timestamp: new Date().toISOString() // Ensures chronological order
            }]);

        if (eventError) throw eventError;

        alert("✅ Status Updated Successfully!");
        location.reload();

    } catch (err) {
        console.error("Update failed:", err);
        alert("❌ Update failed: " + err.message);
    }
}
</script>

</body>
</html>
