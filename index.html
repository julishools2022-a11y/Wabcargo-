<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAB Cargo & Logistics | Track</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --primary: #000000; /* WAB Black */
            --accent: #333333;  /* Dark Gray */
            --light-bg: #f4f4f4;
        }

        body { 
            background-color: var(--light-bg); 
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* HERO SECTION */
        .hero {
            /* Darkened image to make white text pop */
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?auto=format&fit=crop&w=1000&q=80');
            background-size: cover; 
            background-position: center;
            height: 450px; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column;
            text-align: center;
            position: relative;
        }

        /* WAB BIG LOGO STYLE */
        .wab-logo-hero {
            font-family: 'Archivo Black', sans-serif;
            font-size: 5rem;
            line-height: 1;
            letter-spacing: -2px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .wab-subtitle {
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .wab-motto {
            font-style: italic;
            font-weight: 300;
            opacity: 0.9;
            font-size: 1rem;
            border-top: 1px solid rgba(255,255,255,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding: 5px 15px;
            margin-top: 10px;
        }

        /* TRACKING CARD */
        .tracking-box {
            background: white; 
            padding: 40px; 
            border-radius: 4px; /* Sharper corners for industrial look */
            margin-top: -60px; /* Floats over image */
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            width: 100%; 
            max-width: 650px;
            position: relative;
            z-index: 10;
            border-top: 6px solid var(--primary);
        }

        /* INPUT FIELD */
        .form-control-lg {
            border: 2px solid #ddd;
            font-size: 1.1rem;
            padding: 15px;
            border-radius: 4px 0 0 4px;
        }
        .form-control-lg:focus {
            border-color: var(--primary);
            box-shadow: none;
        }

        /* BUTTON */
        .btn-track {
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            padding: 0 40px;
            border: none;
            border-radius: 0 4px 4px 0;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-track:hover { background-color: #333; }

        /* RESULT AREA */
        .status-card { 
            display: none; 
            margin-top: 30px; 
            border-top: 1px solid #eee;
            padding-top: 25px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* TIMELINE */
        .timeline { border-left: 3px solid #000; margin-left: 10px; margin-top: 25px; padding-left: 30px; }
        .timeline-item { position: relative; margin-bottom: 30px; }
        .timeline-dot {
            width: 18px; height: 18px; background: #000; border-radius: 50%;
            position: absolute; left: -41px; top: 4px; border: 4px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .timeline-item.latest .timeline-dot { 
            background: #fff; 
            border: 4px solid #000;
            transform: scale(1.2);
        }
        
        .timeline-date { font-size: 0.8rem; color: #666; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        .timeline-status { font-weight: 700; font-size: 1.1rem; color: #000; }
        .timeline-loc { font-size: 0.95rem; color: #555; }

        /* NAVBAR */
        .navbar { background-color: black !important; }
        .navbar-brand { font-family: 'Archivo Black', sans-serif; letter-spacing: -1px; font-size: 1.5rem; }

        /* FOOTER */
        footer { margin-top: auto; padding: 20px 0; background: #111; color: #888; }
        footer a { color: #888; text-decoration: none; }
        footer a:hover { color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark">
        <div class="container">
            <span class="navbar-brand">
                WAB<span style="color:#aaa">CARGO</span>
            </span>
        </div>
    </nav>

    <div class="hero">
        <div class="wab-logo-hero">WAB</div>
        <div class="wab-subtitle">Cargo and Logistics Services</div>
        <div class="wab-motto">"MOVING GOODS, BUILDING TRUST."</div>
    </div>

    <div class="container d-flex justify-content-center mb-5">
        <div class="tracking-box">
            <label class="fw-bold text-secondary mb-2 small" style="letter-spacing: 1px;">TRACK YOUR SHIPMENT</label>
            <div class="input-group mb-4">
                <input type="text" id="trkInput" class="form-control form-control-lg" placeholder="Enter Waybill (e.g. TRK-123456)" autocomplete="off">
                <button class="btn btn-track" onclick="getShipment()">SEARCH</button>
            </div>

            <div id="loading" class="text-center py-4" style="display:none;">
                <div class="spinner-border text-dark" role="status"></div>
                <p class="small text-muted mt-2">Searching Database...</p>
            </div>

            <div id="errorBox" class="alert alert-dark mt-3 border-0 text-center" style="display:none;"></div>

            <div id="resultBox" class="status-card">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-black text-white rounded-circle p-2 me-2 d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                        <i class="fas fa-box"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold m-0 text-dark">Shipment Found</h5>
                        <small class="text-muted">WAB Cargo Database</small>
                    </div>
                </div>
                
                <div class="row g-3 mb-4 bg-light p-3 rounded mx-0 border">
                    <div class="col-6 border-end">
                        <small class="text-muted fw-bold" style="font-size:0.7rem;">ORIGIN</small>
                        <div id="origin" class="fw-bold fs-5 text-dark">...</div>
                    </div>
                    <div class="col-6 ps-4">
                        <small class="text-muted fw-bold" style="font-size:0.7rem;">DESTINATION</small>
                        <div id="dest" class="fw-bold fs-5 text-dark">...</div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <span class="badge bg-black px-3 py-2 rounded-0">CURRENT STATUS</span>
                    </div>
                    <div class="text-end">
                        <h5 id="statusBadge" class="m-0 fw-bold text-dark">...</h5>
                        <small id="currentLoc" class="text-muted">...</small>
                    </div>
                </div>

                <h6 class="text-uppercase text-muted fw-bold mt-5 border-bottom pb-2" style="font-size: 0.75rem; letter-spacing: 1px;">Tracking History</h6>
                <div class="timeline" id="timelineArea">
                    </div>
            </div>
        </div>
    </div>

    <footer class="text-center">
        <div class="container">
            <small>
                &copy; 2026 WAB Cargo and Logistics Services.
                <br>
                "Moving Goods, Building Trust."
                <br><br>
                <a href="login.html" style="opacity: 0.3; font-size: 0.8rem;">Staff Login</a>
            </small>
        </div>
    </footer>
<script>
    // 1. SAFE CONFIGURATION (Using VAR to prevent crashes)
    var SB_URL = 'https://pfgyfljvysxqsvuiehez.supabase.co';
    var SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmZ3lmbGp2eXN4cXN2dWllaGV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTcyNTMsImV4cCI6MjA4Mzk5MzI1M30.hIt_dGYpiQuKt_LJAfIZlBtnpY6HTt2Dn8xq1gRAXJU';
    
    // Check if client exists. If not, create it.
    if (typeof window.sbHome === 'undefined') {
        window.sbHome = window.supabase.createClient(SB_URL, SB_KEY);
    }
    
    // USE 'var' HERE. 'const' triggers the bug in your editor.
    var sb = window.sbHome;

    // 2. TRACKING LOGIC
    async function getShipment(e) {
        e.preventDefault();
        var btn = document.getElementById('trackBtn');
        var input = document.getElementById('trkInput').value.trim();
        var resultArea = document.getElementById('resultArea');
        var timelineList = document.getElementById('timelineList');

        if(!input) return;

        // Loading State
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        resultArea.style.display = 'none';

        try {
            // Get Shipment
            var { data: ship, error: err1 } = await sb
                .from('shipments')
                .select('*')
                .eq('tracking_number', input)
                .single();

            if(err1 || !ship) throw new Error("Shipment not found");

            // Get History
            var { data: history } = await sb
                .from('shipment_events')
                .select('*')
                .eq('tracking_number', input)
                .order('timestamp', { ascending: false });

            // Fill Data
            document.getElementById('dispTrk').innerText = ship.tracking_number;
            document.getElementById('dispStatus').innerText = ship.status;
            document.getElementById('dispOrigin').innerText = ship.origin;
            document.getElementById('dispDest').innerText = ship.destination;

            // Fill Timeline
            timelineList.innerHTML = '';
            if(history && history.length > 0) {
                history.forEach((event, idx) => {
                    var isLatest = idx === 0 ? 'latest' : '';
                    var dateObj = new Date(event.timestamp || event.created_at);
                    var dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                    timelineList.innerHTML += `
                        <div class="timeline-item ${isLatest}">
                            <div class="timeline-dot"></div>
                            <div class="time-date">${dateStr}</div>
                            <div class="time-status">${event.status}</div>
                            <div class="time-loc">${event.location}</div>
                        </div>
                    `;
                });
            } else {
                timelineList.innerHTML = '<div class="text-muted">No history available yet.</div>';
            }

            // Show Result
            resultArea.style.display = 'block';

        } catch (err) {
            alert("Search Result: " + err.message);
        } finally {
            btn.innerHTML = 'TRACK';
        }
    }
</script>

</body>
</html>
